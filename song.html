<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>播放页面</title>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="./reset.css">
    <style>
        body{
            width:100vw;
         }

        .undergroundImg{
            z-index:-1;
            position: absolute;
            width:100vw;
            height:100vh;
            display: block;
            content:'';
            background:transparent url(//i.loli.net/2017/08/31/59a775adbd3f9.jpg) center no-repeat;
            background-size: cover;
            filter: blur(40px) brightness(0.4);
        }
        .guanghuan{
            margin:0 auto;
            top:80px;
            width: 300px;
            height:300px;
            position: relative;
        }
        .guanghuan::before{
            position: absolute;
            width:100%;
            height:100%;
            content:'';
            background:url(https://i.loli.net/2017/08/31/59a77825f1f96.png) no-repeat;
            background-size:cover;
            z-index: 4;
        }
        .guanghuan.playing::before{
            animation: spin 8s infinite linear;
        }
        .guanghuan.pausing::before{
            -webkit-animation-play-state:paused;
            -moz-animation-play-state:paused;
            -o-animation-play-state:paused;
            animation-play-state:paused;
        }
        .diezi{
            width:100%;
            height:100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .diezi::before{
            left:0;
            right:0;
            position: absolute;
            width:100%;
            height:100%;
            content:'';
            background:url(https://i.loli.net/2017/08/31/59a77941ec24a.png) no-repeat;
            background-size:cover;
            z-index:1;
        }
        .diezi > .innerPic > img{
            border-radius:50%;
            width:200px;
            height:200px;
        }
        .innerPic.playing{
            animation: spin 8s infinite linear;
        }
        .innerPic.pausing{

            -webkit-animation-play-state:paused;
            -moz-animation-play-state:paused;
            -o-animation-play-state:paused;
            animation-play-state:paused;

}
        .diezi > .pause {
            z-index: 9;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            position: absolute;
        }
        .diezi > .pause > img{
            vertical-align: top;
        }
        .diezi > .pause.active {
            display: none;
        }
        .diezi > .play{
            z-index: 9;
            top:50%;
            left:50%;
            transform:translate(-50%,-50%);
            position: absolute;
        }
        .diezi > .play > img {
            vertical-align: top;
        }
        .diezi > .play.active {
            display: none;
        }
        @keyframes spin {
            form{
                transform: rotateZ(0deg);
            }
            to{
                transform: rotateZ(360deg);
            }
        }
        @media (min-width: 415px) {
            .guanghuan {
                width: 500px;
                height: 500px;
            }

            .diezi > .innerPic > img {
                width: 333.333333333px;
                height:333.333333333px;
            }
            .diezi > .play > img{
                width:133.333333333px;
                height:133.333333333px;
            }
            .diezi > .pause > img{
                width:133.333333333px;
                height:133.333333333px;
            }
        }
        p{
            text-align: center;}
        .title{
            font-family:Helvetica,sans-serif;
            margin-top:100px;
            text-align: center;
        }
        span{
            color:#B3B29E;
        }
        .name{
            color:white;
        }
        .lyricWrapper{
            border:1px solid red;
            height:100px;
            display: flex;
            align-items: center;
            overflow: hidden;
            position: relative;
        }
        .lyric{
            top:27px;
            position: absolute;
            height:27px;
            border:1px solid blue;
            font-size:17px;
            line-height:31px;
            overflow: visible;
            width:100%;
            color:#ccc;
            transition: 0.2s linear;
        }

    </style>

</head>
<body>
    <div class="undergroundImg"></div>
    <div class="guanghuan">
        <div class="diezi">
            <div class="innerPic">
                <img  src="//i.loli.net/2017/08/31/59a775adbd3f9.jpg">
            </div>
            <div class="pause active">
                <img src="//i.loli.net/2017/08/30/59a6be4466ded.png" alt=""  width="80" height="80">
            </div>
            <div class="play">
                <img src="//i.loli.net/2017/08/30/59a6bf42757e3.png" alt="" width="80" height="80">
            </div>
        </div>
    </div>
    <div class="lyricWrapper"></div>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="//cdn1.lncld.net/static/js/3.1.0/av-min.js"></script>
    <script>
        var APP_ID = 'mILQIQweB355cMMwGy6EG0n0-gzGzoHsz';
        var APP_KEY = '6BUMFbB1BVsphGS0CwCiYTDy';
        AV.init({
            appId: APP_ID,
            appKey: APP_KEY
        });
        var audio = document.createElement('audio');
        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }
        var id = getParameterByName('id');
        var query = new AV.Query('song');
        query.get(id).then(function (song) {
            audio.src = song.attributes.url;
            $('.undergroundImg').css("background-image",'url('+song.attributes.cover+')');
            $('.diezi>.innerPic>img').attr('src',song.attributes.cover)
            var p = document.createElement('p')
            p.classList.add('title');
            var span1 = document.createElement('span')
            var span2 = document.createElement('span')
            var lyric = document.createElement('div')
            lyric.classList.add('lyric')
            span1.classList.add('name');
            span1.textContent = song.attributes.name + ' - ';
            span2.textContent = song.attributes.singer;
            $(p).append(span1).append(span2);
            $(p).insertBefore('.lyricWrapper');
            var regex = /^\[(.+)\](.*)$/
            var array  = song.attributes.lyric.split('\n');
            array = array.map(function(string,index){
                var matches = string.match(regex);
                if(matches){
                    return {time:matches[1],words:matches[2]}
                }
            })
            var $lyric = $(lyric);
            array.map(function(object){
                var $p = $('<p/>')
                $p.attr('data-time',object.time).text(object.words);
                $p.addClass('myData');
                $p.appendTo($lyric);
            })
            $('.lyricWrapper').append($lyric);
         })
        function hmsToSeconds(hms){
            var a = hms.split(':');
            var seconds = (+a[0])* 60 + (+a[1]);
            return seconds;
        }
        var n1 = 27;
        Number.prototype.toFixed1=function (){
            return parseFloat(this.toString().replace(/(\.\d{1})\d+$/,"$1"));
        }
        audio.ontimeupdate = function(){
                var time = audio.currentTime;
                console.log(time);
                for(var i = 0;i<$('.myData').length;i++){
                    var dataTime = $($('.myData')[i]).attr('data-time');
                if(hmsToSeconds(dataTime).toFixed1() === time.toFixed1()){
                    console.log('bingo');
                        $('.lyric').css('top',n1);
                        n1 -= 27;
                }
                }

        }
        $('.play').on('click',function(){
            audio.play();
            $('.play').addClass('active');
            $('.pause').removeClass('active');
            if($('.guanghuan').hasClass('playing')){}
            else{
            $('.guanghuan').addClass('playing')
            }
            $('.guanghuan') .removeClass('pausing');
            if($('.innerPic').hasClass('playing')){}
            else{
                $('.innerPic').addClass('playing')
            }
            $('.innerPic').removeClass('pausing');
        });
        $('.pause').on('click',function(){
            audio.pause();
            $('.pause').addClass('active');
            $('.play').removeClass('active');
            $('.guanghuan').addClass('pausing');
            $('.innerPic').addClass('pausing');
        })
    </script>
</div>
</body>
</html>